<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRRT E-learning MICU SRK</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
            /* ซ่อนเนื้อหาหลักไว้ก่อน เพื่อรอการตรวจสอบ Login */
            visibility: hidden; 
        }

        .navy-gradient {
            background: linear-gradient(135deg, #0a2463 0%, #1e3a8a 100%);
        }

        .hero-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e3a8a' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #0a2463;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="hero-pattern">

    <div class="modal fade" id="loginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header navy-gradient text-white">
                    <h5 class="modal-title" id="loginModalLabel">CRRT E-learning | เข้าสู่ระบบ</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">ชื่อผู้ใช้งาน</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div id="errorMessage" class="alert alert-danger d-none" role="alert"></div>
                        <button type="submit" id="loginButton" class="btn btn-primary w-100" style="background-color: #0a2463; border-color: #0a2463;">
                            <span id="loginButtonText">เข้าสู่ระบบ</span>
                            <span id="loginSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content">
        <nav class="navbar navbar-expand-lg navbar-dark navy-gradient shadow-lg">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="https://raw.githubusercontent.com/nuksc/logo/refs/heads/main/%E0%B8%AB%E0%B8%AD%E0%B8%9C%E0%B8%B9%E0%B9%89%E0%B8%9B%E0%B9%88%E0%B8%A7%E0%B8%A2%E0%B8%A7%E0%B8%B4%E0%B8%81%E0%B8%A4%E0%B8%95%E0%B8%AD%E0%B8%B2%E0%B8%A2%E0%B8%B8%E0%B8%A3%E0%B8%81%E0%B8%A3%E0%B8%A3%E0%B8%A1%20%E0%B9%82%E0%B8%A3%E0%B8%87%E0%B8%9E%E0%B8%A2%E0%B8%B2%E0%B8%9A%E0%B8%B2%E0%B8%A5%E0%B8%AA%E0%B8%A1%E0%B9%80%E0%B8%94%E0%B9%87%E0%B8%88%E0%B8%9E%E0%B8%A3%E0%B8%B0%E0%B8%99%E0%B8%B2%E0%B8%87%E0%B9%80%E0%B8%88%E0%B9%89%E0%B8%B2%E0%B8%AA%E0%B8%B4%E0%B8%A3%E0%B8%B4%E0%B8%81%E0%B8%B4%E0%B8%95%E0%B8%B4%E0%B9%8C%20(1).png" alt="MICU SRK Logo" style="height: 48px;" class="me-3">
                    <span class="fs-5 fw-bold">CRRT E-learning MICU SRK</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">หน้าหลัก</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#courses">บทเรียน</a>
                        </li>
                        <li id="userInfo" class="nav-item dropdown d-none">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                สวัสดี, <span id="userFullname"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                <li><a id="logoutButton" class="dropdown-item" href="#">ออกจากระบบ</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <section class="py-5">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-5 mb-md-0">
                        <h1 class="display-4 fw-bold text-dark">
                            <span style="color: #0a2463;">CRRT E-learning</span><br>สำหรับพยาบาลวิชาชีพ
                        </h1>
                        <p class="lead text-secondary my-4">
                            แหล่งเรียนรู้ออนไลน์เกี่ยวกับ Continuous Renal Replacement Therapy สำหรับบุคลากรทางการแพทย์ โดยหอผู้ป่วยวิกฤตอายุรกรรม โรงพยาบาลสมเด็จพระนางเจ้าสิริกิติ์
                        </p>
                        <a href="#courses" class="btn btn-lg text-white px-5 py-3 rounded-pill" style="background-color: #0a2463;">
                            เริ่มเรียนรู้
                        </a>
                    </div>
                    <div class="col-md-6 d-flex justify-content-center">
                        <div class="float-animation">
                             <svg class="w-full max-w-lg" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg">
                                 <defs>
                                     <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                                         <stop offset="0%" style="stop-color:#0a2463;stop-opacity:1"></stop>
                                         <stop offset="100%" style="stop-color:#4361ee;stop-opacity:1"></stop>
                                     </linearGradient>
                                 </defs>
                                 <path fill="#e6f0ff" d="M370,290 C430,250 450,180 430,130 C410,80 350,50 290,50 C230,50 180,90 150,130 C120,170 100,220 120,260 C140,300 200,330 260,330 C320,330 350,310 370,290 Z"></path>
                                 <circle cx="250" cy="180" r="120" fill="url(#grad1)" opacity="0.1"></circle>
                                
                                 <rect x="180" y="100" width="140" height="200" rx="10" fill="#f0f4f8" stroke="#0a2463" stroke-width="3"></rect>
                                 <rect x="190" y="120" width="120" height="70" rx="5" fill="#e6e6e6" stroke="#0a2463" stroke-width="2"></rect>
                                 <circle cx="250" cy="230" r="30" fill="#ffffff" stroke="#0a2463" stroke-width="2"></circle>
                                 <circle cx="250" cy="230" r="25" fill="none" stroke="#0a2463" stroke-width="2" stroke-dasharray="4 2"></circle>
                                
                                 <rect x="200" y="140" width="100" height="40" rx="3" fill="#ffffff" stroke="#0a2463" stroke-width="1"></rect>
                                 <circle cx="220" cy="280" r="8" fill="#4361ee"></circle>
                                 <circle cx="250" cy="280" r="8" fill="#0a2463"></circle>
                                 <circle cx="280" cy="280" r="8" fill="#4361ee"></circle>
                                
                                 <path d="M180,150 Q160,170 160,200 Q160,230 140,250" fill="none" stroke="#ff6b6b" stroke-width="3"></path>
                                 <path d="M320,150 Q340,170 340,200 Q340,230 360,250" fill="none" stroke="#4cc9f0" stroke-width="3"></path>
                             </svg>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="courses" class="py-5 bg-light">
            <div class="container">
                <div class="text-center mb-5">
                    <h2 class="fw-bold text-dark">บทเรียนของเรา</h2>
                    <p class="text-secondary mx-auto" style="max-width: 600px;">เรียนรู้เกี่ยวกับ CRRT ผ่านบทเรียนที่ออกแบบมาสำหรับพยาบาลวิชาชีพโดยเฉพาะ</p>
                </div>
                <div id="course-container" class="row g-4 justify-content-center">
                    </div>
            </div>
        </section>

        <footer class="navy-gradient text-white py-4">
            <div class="container">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                    <div class="d-flex align-items-center mb-3 mb-md-0">
                        <img src="https://raw.githubusercontent.com/nuksc/logo/refs/heads/main/%E0%B8%AB%E0%B8%AD%E0%B8%9C%E0%B8%B9%E0%B9%89%E0%B8%9B%E0%B9%88%E0%B8%A7%E0%B8%A2%E0%B8%A7%E0%B8%B4%E0%B8%81%E0%B8%A4%E0%B8%95%E0%B8%AD%E0%B8%B2%E0%B8%A2%E0%B8%B8%E0%B8%A3%E0%B8%81%E0%B8%A3%E0%B8%A3%E0%B8%A1%20%E0%B9%82%E0%B8%A3%E0%B8%87%E0%B8%9E%E0%B8%A2%E0%B8%B2%E0%B8%9A%E0%B8%B2%E0%B8%A5%E0%B8%AA%E0%B8%A1%E0%B9%80%E0%B8%94%E0%B9%87%E0%B8%88%E0%B8%9E%E0%B8%A3%E0%B8%B0%E0%B8%99%E0%B8%B2%E0%B8%87%E0%B9%80%E0%B8%88%E0%B9%89%E0%B8%B2%E0%B8%AA%E0%B8%B4%E0%B8%A3%E0%B8%B4%E0%B8%81%E0%B8%B4%E0%B8%95%E0%B8%B4%E0%B9%8C%20(1).png" alt="MICU SRK Logo" style="height: 40px;" class="me-3">
                        <div>
                            <h6 class="mb-0 fw-bold">CRRT E-learning MICU SRK</h6>
                            <small>หอผู้ป่วยวิกฤตอายุรกรรม โรงพยาบาลสมเด็จพระนางเจ้าสิริกิติ์</small>
                        </div>
                    </div>
                    <div class="text-center text-md-end">
                        <small>© 2025 MICU SRK. All rights reserved.</small>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        const loginForm = document.getElementById('loginForm');
        const mainBody = document.querySelector('body');
        const errorMessageDiv = document.getElementById('errorMessage');
        const loginButton = document.getElementById('loginButton');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginSpinner = document.getElementById('loginSpinner');
        const userInfoNav = document.getElementById('userInfo');
        const userFullnameSpan = document.getElementById('userFullname');
        const logoutButton = document.getElementById('logoutButton');

        // ===================================================================================
        //  สำคัญ! แก้ไข URL นี้ให้เป็น Web App URL ของ Google Apps Script ของคุณ
        // ===================================================================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdP_NcUseobp8xMCO6u0yR9ZGtwfvPDFU8HZzEC4gaOtmAz6WH0FQFY3X5_J1Wno1A/exec'; 

        // 1. ตรวจสอบสถานะการล็อกอินเมื่อเปิดหน้าเว็บ
        checkLoginStatus();

        // 2. จัดการการ Submit ฟอร์มล็อกอิน
        loginForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // แสดง Spinner, ซ่อน Text
            loginButtonText.classList.add('d-none');
            loginSpinner.classList.remove('d-none');
            loginButton.disabled = true;
            errorMessageDiv.classList.add('d-none');

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: "follow",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8",
                    },
                    body: JSON.stringify({ username: username, password: password })
                });

                const result = await response.json();

                if (result.status === 'success' && result.user) {
                    // 3. บันทึกข้อมูลลง sessionStorage
                    sessionStorage.setItem('loggedInUser', JSON.stringify(result.user));
                    
                    // 4. ตั้งค่าหน้าเว็บสำหรับผู้ใช้ที่ล็อกอิน
                    setupUIForLoggedInUser(result.user);
                } else {
                    throw new Error(result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
                }
            } catch (error) {
                errorMessageDiv.innerText = error.message;
                errorMessageDiv.classList.remove('d-none');
            } finally {
                // คืนค่าปุ่มให้เหมือนเดิม
                loginButtonText.classList.remove('d-none');
                loginSpinner.classList.add('d-none');
                loginButton.disabled = false;
            }
        });

        // 5. จัดการการออกจากระบบ
        logoutButton.addEventListener('click', function(e) {
            e.preventDefault();
            sessionStorage.removeItem('loggedInUser'); // ล้างข้อมูลผู้ใช้
            location.reload(); // รีโหลดหน้าเพื่อกลับไปหน้าล็อกอิน
        });

        // --- ฟังก์ชันช่วยเหลือ ---

        function checkLoginStatus() {
            const userDataString = sessionStorage.getItem('loggedInUser');
            if (userDataString) {
                const userData = JSON.parse(userDataString);
                setupUIForLoggedInUser(userData);
            } else {
                mainBody.style.visibility = 'visible'; // ทำให้ body แสดงผลก่อนเปิด modal
                loginModal.show(); // ถ้าไม่มีข้อมูล ให้แสดงหน้าต่างล็อกอิน
            }
        }

        function setupUIForLoggedInUser(userData) {
            mainBody.style.visibility = 'visible'; // แสดงเนื้อหาเว็บ
            loginModal.hide(); // ซ่อนหน้าต่างล็อกอิน

            // แสดงชื่อผู้ใช้บน Navbar
            userFullnameSpan.innerText = userData.fullname;
            userInfoNav.classList.remove('d-none'); // แสดง Dropdown ของผู้ใช้

            loadCourses(); // โหลดข้อมูลบทเรียน
        }
        
        async function loadCourses() {
            const courseContainer = document.getElementById('course-container');
            courseContainer.innerHTML = '<div class="col text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            try {
                // ใช้ GET request เพื่อดึงข้อมูลบทเรียน
                const response = await fetch(APPS_SCRIPT_URL);
                const courses = await response.json();
                
                courseContainer.innerHTML = ''; // ล้าง Spinner

                if (courses.length === 0) {
                  courseContainer.innerHTML = '<p class="text-center text-muted">ไม่พบบทเรียนในขณะนี้</p>';
                  return;
                }

                courses.forEach(course => {
                    const defaultImage = 'https://images.unsplash.com/photo-1581093450021-4a7360e9a1c8?q=80&w=2070&auto=format&fit=crop';
                    const cardHtml = `
                        <div class="col-md-6 col-lg-5">
                            <div class="card h-100 shadow-sm border-0 overflow-hidden">
                                <img src="${course.image || defaultImage}" class="card-img-top" alt="${course.title}" style="height: 200px; object-fit: cover;">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title fw-bold">${course.title}</h5>
                                    <p class="card-text text-secondary mb-4">${course.description}</p>
                                    <a href="${course.link}" target="_blank" class="btn text-white mt-auto" style="background-color: #0a2463;">เข้าสู่บทเรียน</a>
                                </div>
                            </div>
                        </div>`;
                    courseContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
            } catch (error) {
                console.error('Failed to load courses:', error);
                courseContainer.innerHTML = '<div class="col text-center"><p class="text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูลบทเรียน</p></div>';
            }
        }
    });
    </script>
</body>
</html>